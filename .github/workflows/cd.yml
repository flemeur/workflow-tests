name: CD

on:
  workflow_call:
    inputs:
      environment:
        description: "Environment to deploy to"
        type: string
        required: true

concurrency:
  group: ${{ github.workflow }}-deploy-${{ inputs.environment }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    name: "Setup"

    runs-on: ubuntu-latest

    environment: ${{ inputs.environment }}

    outputs:
      hostnames: ${{ steps.matrix.outputs.hostnames }}

    steps:
      - name: Print
        run: |
          echo "Deploy hostnames: ${{ vars.DEPLOY_HOSTNAMES }}"

      - id: matrix
        run: |
          # echo "value=$(echo '${{ vars.DEPLOY_HOSTNAMES}}' | sed 's/\"/\\\"/g')" >> $GITHUB_OUTPUT
          HOSTNAMES='${{ toJSON(vars.DEPLOY_HOSTNAMES) }}'
          echo "hostnames=${HOSTNAMES}" >> $GITHUB_OUTPUT

  test:
    name: "Test"

    runs-on: ubuntu-latest

    needs: setup

    steps:
      - name: Print
        run: |
          echo "${{ toJSON(needs.setup.outputs.hostnames) }}"

  deploy:
    name: "Deploy"

    runs-on: ubuntu-latest

    needs: [setup, test]

    environment: ${{ inputs.environment }}

    strategy:
      matrix:
        hostname: ${{ needs.setup.outputs.hostnames }}

    steps:
      - name: Print
        run: |
          echo "Deploying to environment: ${{ inputs.environment }} on host: ${{ matrix.hostname }}"
